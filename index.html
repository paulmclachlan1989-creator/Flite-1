<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flite ‚Äî Deal Engine</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');
:root{--gold:#D4A017;--gold2:#E8B82A;--gold-pale:#FDF8EC;--gold-dim:rgba(212,160,23,0.13);--dark:#141210;--dark2:#1E1A14;--ink:#2A2318;--mid:#7A6E5A;--border:#E8E0D0;--bg:#F7F4EE;--white:#FFFFFF;--green:#2E8B57;--green-bg:rgba(46,139,87,0.08);--red:#C0392B;--red-bg:rgba(192,57,43,0.08);--blue:#2C5F8A;--blue-bg:rgba(44,95,138,0.08)}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh}
.sidebar{position:fixed;top:0;left:0;bottom:0;width:230px;background:var(--dark);z-index:100;display:flex;flex-direction:column}
.logo-wrap{padding:22px 20px 18px;border-bottom:1px solid rgba(255,255,255,.05);display:flex;align-items:center;gap:12px}
.logo-circle{width:42px;height:42px;border-radius:50%;background:var(--white);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.logo-name{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:700;color:var(--white);line-height:1.2}
.logo-tag{font-family:'DM Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);letter-spacing:2px;text-transform:uppercase}
nav{flex:1;padding:14px 0}
.nav-group{padding:10px 20px 3px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.2)}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;cursor:pointer;font-size:13.5px;color:rgba(255,255,255,.45);border-left:2px solid transparent;transition:all .15s}
.nav-item:hover{color:rgba(255,255,255,.8);background:rgba(255,255,255,.03)}
.nav-item.active{color:var(--gold2);background:rgba(212,160,23,.07);border-left-color:var(--gold);font-weight:500}
.nav-icon{width:16px;text-align:center;font-size:14px}
.nav-badge{margin-left:auto;background:var(--gold);color:var(--dark);font-size:10px;font-weight:700;padding:1px 7px;border-radius:10px;font-family:'DM Mono',monospace}
.sidebar-foot{padding:14px 20px;border-top:1px solid rgba(255,255,255,.05);font-family:'DM Mono',monospace;font-size:10px;color:rgba(255,255,255,.18)}
.main{margin-left:230px;min-height:100vh;display:flex;flex-direction:column}
.topbar{background:var(--white);border-bottom:1px solid var(--border);height:58px;padding:0 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.page-title{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--dark)}
.topbar-right{display:flex;align-items:center;gap:14px}
.ai-pill{display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:20px;background:var(--green-bg);color:var(--green);font-family:'DM Mono',monospace;font-size:11px}
.ai-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
.content{padding:28px 32px;flex:1}
.panel{display:none}.panel.active{display:block;animation:fadeUp .2s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--white);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.card-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-size:13px;font-weight:600;color:var(--dark)}
.card-body{padding:20px}
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:7px;border:none;font-family:'DM Sans',sans-serif;font-size:13.5px;font-weight:500;cursor:pointer;transition:all .15s}
.btn-gold{background:var(--gold);color:var(--dark)}.btn-gold:hover{background:var(--gold2);box-shadow:0 3px 14px rgba(212,160,23,.3);transform:translateY(-1px)}
.btn-dark{background:var(--dark);color:var(--white)}.btn-dark:hover{background:var(--dark2)}
.btn-outline{background:transparent;color:var(--ink);border:1.5px solid var(--border)}.btn-outline:hover{border-color:var(--gold);color:var(--gold)}
.btn-sm{padding:6px 13px;font-size:12.5px}.btn:disabled{opacity:.45;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.field{display:flex;flex-direction:column;gap:5px;margin-bottom:14px}
.field label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--mid)}
.field input,.field select,.field textarea{border:1.5px solid var(--border);border-radius:7px;padding:9px 12px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--ink);background:var(--white);outline:none;transition:border-color .15s,box-shadow .15s}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(212,160,23,.1)}
.field textarea{resize:vertical;min-height:80px;line-height:1.6}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.upload-zone{border:2px dashed var(--border);border-radius:10px;padding:32px 20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg);position:relative}
.upload-zone:hover,.upload-zone.drag{border-color:var(--gold);background:var(--gold-pale)}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-icon{font-size:28px;margin-bottom:8px}.upload-title{font-size:14px;font-weight:500;color:var(--ink);margin-bottom:3px}.upload-sub{font-size:12px;color:var(--mid)}
.ai-output{background:var(--dark2);border-radius:10px;overflow:hidden;border:1px solid rgba(212,160,23,.15)}
.ai-output-head{padding:11px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.05);background:rgba(212,160,23,.04)}
.ai-output-label{font-family:'DM Mono',monospace;font-size:11px;color:var(--gold2);letter-spacing:.5px}
.ai-spinner{width:13px;height:13px;border:2px solid rgba(212,160,23,.25);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;display:none}
.ai-spinner.on{display:block}@keyframes spin{to{transform:rotate(360deg)}}
.ai-output-body{padding:18px;min-height:120px;font-size:13.5px;line-height:1.75;color:rgba(255,255,255,.75)}
.ai-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:140px;color:rgba(255,255,255,.2);gap:8px;text-align:center}
.ai-empty-icon{font-size:28px}
.badge{display:inline-flex;align-items:center;padding:2px 9px;border-radius:12px;font-size:10.5px;font-family:'DM Mono',monospace;letter-spacing:.3px;text-transform:uppercase;font-weight:500}
.bg{background:var(--green-bg);color:var(--green)}.ba{background:var(--gold-dim);color:#7A5A00}.br{background:var(--red-bg);color:var(--red)}.bb{background:var(--blue-bg);color:var(--blue)}.bx{background:#F0EDE7;color:var(--mid)}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:18px 20px;position:relative;overflow:hidden}
.stat::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--gold);transform:scaleX(0);transform-origin:left;transition:transform .3s}
.stat:hover::before{transform:scaleX(1)}
.stat-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--mid);margin-bottom:8px}
.stat-val{font-family:'Cormorant Garamond',serif;font-size:30px;font-weight:700;color:var(--dark);line-height:1}
.stat-sub{font-size:11.5px;color:var(--mid);margin-top:5px}
.pipeline{display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--white);margin-bottom:24px}
.stage{flex:1;padding:14px 0;text-align:center;border-right:1px solid var(--border);cursor:pointer;transition:background .15s}
.stage:last-child{border-right:none}.stage:hover{background:var(--gold-pale)}
.stage-n{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--dark);display:block}
.stage-n.g{color:var(--gold)}.stage-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--mid);margin-top:2px}
.deal-table{width:100%;border-collapse:collapse}
.deal-table th{padding:10px 16px;text-align:left;font-family:'DM Mono',monospace;font-size:9.5px;letter-spacing:1.2px;text-transform:uppercase;color:var(--mid);border-bottom:1px solid var(--border);background:#FAFAF8}
.deal-table td{padding:12px 16px;border-bottom:1px solid #F2EFE8;font-size:13.5px;color:var(--ink);vertical-align:middle}
.deal-table tr:last-child td{border-bottom:none}.deal-table tr:hover td{background:#FAFAF8}
.lender-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.lender-card{background:var(--white);border:1.5px solid var(--border);border-radius:10px;padding:18px;cursor:pointer;transition:all .15s;position:relative}
.lender-card:hover{border-color:var(--gold);box-shadow:0 2px 16px rgba(212,160,23,.12)}
.lender-card.hi{border-color:var(--gold);background:var(--gold-pale)}
.lender-card-name{font-weight:600;font-size:14px;color:var(--dark);margin-bottom:6px}
.lender-card-meta{font-size:11.5px;color:var(--mid);line-height:1.8}
.match-score{position:absolute;top:12px;right:12px;font-family:'DM Mono',monospace;font-size:11px;font-weight:500;padding:2px 8px;border-radius:10px}
.ms-h{background:var(--green-bg);color:var(--green)}.ms-m{background:var(--gold-dim);color:#7A5A00}.ms-l{background:var(--red-bg);color:var(--red)}
.metric-row{display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-bottom:1px solid #F2EFE8;font-size:13.5px}
.metric-row:last-child{border-bottom:none}.metric-label{color:var(--mid)}.metric-val{font-family:'DM Mono',monospace;font-weight:500;color:var(--dark)}
.metric-val.good{color:var(--green)}.metric-val.warn{color:#B8860B}.metric-val.bad{color:var(--red)}
.tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:22px}
.tab{padding:10px 18px;cursor:pointer;font-size:13.5px;font-weight:500;color:var(--mid);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
.tab:hover{color:var(--dark)}.tab.active{color:var(--gold);border-bottom-color:var(--gold)}
.psec-title{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--mid);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.notif{display:flex;align-items:flex-start;gap:10px;padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:13.5px;line-height:1.6}
.notif-info{background:var(--blue-bg);color:var(--blue);border:1px solid rgba(44,95,138,.15)}
.notif-ok{background:var(--green-bg);color:var(--green);border:1px solid rgba(46,139,87,.15)}
.notif-warn{background:#FFF8E1;color:#7A5A00;border:1px solid rgba(212,160,23,.2)}
</style>

<style>
.login-overlay {
  position:fixed;inset:0;z-index:9999;background:#141210;
  display:flex;align-items:center;justify-content:center;
}
.login-box {
  width:380px;padding:48px 40px;background:#1E1A14;
  border:1px solid rgba(212,160,23,.2);border-radius:16px;text-align:center;
}
.login-logo {
  width:64px;height:64px;border-radius:50%;background:white;
  margin:0 auto 24px;display:flex;align-items:center;justify-content:center;
}
.login-title {
  font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;
  color:white;margin-bottom:4px;
}
.login-sub {
  font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;
  text-transform:uppercase;color:rgba(255,255,255,.3);margin-bottom:36px;
}
.login-input {
  width:100%;padding:12px 16px;background:rgba(255,255,255,.05);
  border:1.5px solid rgba(255,255,255,.1);border-radius:8px;color:white;
  font-family:'DM Sans',sans-serif;font-size:15px;outline:none;
  text-align:center;letter-spacing:3px;margin-bottom:14px;transition:border-color .15s;
}
.login-input:focus{border-color:#D4A017;}
.login-input::placeholder{letter-spacing:1px;color:rgba(255,255,255,.2);}
.login-btn {
  width:100%;padding:12px;background:#D4A017;color:#141210;border:none;
  border-radius:8px;font-family:'DM Sans',sans-serif;font-size:15px;
  font-weight:600;cursor:pointer;transition:all .15s;
}
.login-btn:hover{background:#E8B82A;transform:translateY(-1px);}
.login-error {
  margin-top:12px;padding:10px;background:rgba(192,57,43,.1);
  border:1px solid rgba(192,57,43,.2);border-radius:6px;
  color:#E74C3C;font-size:13px;display:none;
}
.login-spinner {
  width:18px;height:18px;border:2px solid rgba(212,160,23,.3);
  border-top-color:#D4A017;border-radius:50%;
  animation:lspin .7s linear infinite;margin:12px auto 0;display:none;
}
@keyframes lspin{to{transform:rotate(360deg);}}
</style>
</head>
<body>


<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div class="login-logo">
      <svg viewBox="0 0 100 100" fill="none" width="36" height="36">
        <line x1="22" y1="78" x2="22" y2="22" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/>
        <line x1="22" y1="22" x2="78" y2="22" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/>
        <line x1="22" y1="50" x2="65" y2="50" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/>
        <line x1="22" y1="78" x2="65" y2="35" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="login-title">Flite</div>
    <div class="login-sub">Deal Engine &middot; Secure Access</div>
    <input class="login-input" type="password" id="loginPassword"
      placeholder="Enter password"
      onkeydown="if(event.key==='Enter')doLogin()"
      autofocus />
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-spinner" id="loginSpinner"></div>
    <div class="login-error" id="loginError">Incorrect password. Please try again.</div>
  </div>
</div>


<div id="appContainer" style="display:none">
<aside class="sidebar">
  <div class="logo-wrap">
    <div class="logo-circle">
      <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" width="28" height="28">
        <line x1="22" y1="78" x2="22" y2="22" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/>
        <line x1="22" y1="22" x2="78" y2="22" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/>
        <line x1="22" y1="50" x2="65" y2="50" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/>
        <line x1="22" y1="78" x2="65" y2="35" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/>
      </svg>
    </div>
    <div><div class="logo-name">Flite</div><div class="logo-tag">Deal Engine</div></div>
  </div>
  <nav>
    <div class="nav-group">Overview</div>
    <div class="nav-item active" onclick="nav('dashboard',this)"><span class="nav-icon">‚óà</span>Dashboard</div>
    <div class="nav-group">Deal Flow</div>
    <div class="nav-item" onclick="nav('upload',this)"><span class="nav-icon">‚Üë</span>Upload Documents</div>
    <div class="nav-item" onclick="nav('analytics',this)"><span class="nav-icon">‚óé</span>Credit Analytics</div>
    <div class="nav-item" onclick="nav('proposal',this)"><span class="nav-icon">‚ú¶</span>Generate Proposal<span class="nav-badge" id="propBadge" style="display:none">1</span></div>
    <div class="nav-group">Lenders</div>
    <div class="nav-item" onclick="nav('lenders',this)"><span class="nav-icon">‚äû</span>Lender Criteria<span class="nav-badge" id="lenderBadge">0</span></div>
    <div class="nav-item" onclick="nav('matcher',this)"><span class="nav-icon">‚ü≥</span>Lender Matcher</div>
    <div class="nav-group">Downloads</div>
    <div class="nav-item" onclick="nav('templates',this)"><span class="nav-icon">‚§ì</span>Templates</div>
  </nav>
  <div class="sidebar-foot">Flite Commercial Finance ¬∑ v1.0</div>
</aside>

<main class="main">
  <div class="topbar">
    <div class="page-title" id="pageTitle">Dashboard</div>
    <div class="topbar-right">
      <div class="ai-pill"><div class="ai-dot"></div>Claude AI Ready</div>
      <button class="btn btn-gold btn-sm" onclick="nav('upload',document.querySelector('[onclick*=upload]'))">+ New Deal</button>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="panel active" id="panel-dashboard">
      <div class="stats-row">
        <div class="stat"><div class="stat-label">Lenders Loaded</div><div class="stat-val" id="d-lenders">0</div><div class="stat-sub">Upload criteria to start</div></div>
        <div class="stat"><div class="stat-label">Proposals Generated</div><div class="stat-val" id="d-proposals">0</div><div class="stat-sub">This session</div></div>
        <div class="stat"><div class="stat-label">Analyses Run</div><div class="stat-val" id="d-analyses">0</div><div class="stat-sub">Credit assessments</div></div>
        <div class="stat"><div class="stat-label">Status</div><div class="stat-val" style="font-size:20px;margin-top:4px">Ready</div><div class="stat-sub up">All systems active</div></div>
      </div>
      <div class="pipeline">
        <div class="stage"><span class="stage-n">0</span><div class="stage-lbl">New</div></div>
        <div class="stage"><span class="stage-n">0</span><div class="stage-lbl">Packaged</div></div>
        <div class="stage"><span class="stage-n g">0</span><div class="stage-lbl">Submitted</div></div>
        <div class="stage"><span class="stage-n">0</span><div class="stage-lbl">Offer</div></div>
        <div class="stage"><span class="stage-n">0</span><div class="stage-lbl">Completed</div></div>
      </div>
      <div class="notif notif-info"><span>‚Ñπ</span><div><strong>Getting started:</strong> (1) Add your Anthropic API key when prompted ¬∑ (2) Upload lender criteria in <strong>Lender Criteria</strong> ¬∑ (3) Upload client documents in <strong>Upload Documents</strong> ¬∑ (4) Run credit analysis ¬∑ (5) Generate proposal.</div></div>
      <div class="card"><div class="card-head"><div class="card-title">Quick Actions</div></div>
        <div class="card-body" style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn btn-gold" onclick="nav('upload',document.querySelector('[onclick*=upload]'))">‚Üë Upload Client Documents</button>
          <button class="btn btn-outline" onclick="nav('lenders',document.querySelector('[onclick*=lenders]'))">‚äû Add Lender Criteria</button>
          <button class="btn btn-outline" onclick="nav('templates',document.querySelector('[onclick*=templates]'))">‚§ì Download Blank Template</button>
        </div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div class="panel" id="panel-upload">
      <div class="notif notif-info"><span>‚Ñπ</span><div>Upload redacted client documents. Claude AI will extract financials, calculate ratios, and pre-populate the proposal template. Documents are processed in-session only ‚Äî nothing is stored externally.</div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
        <div>
          <div class="card" style="margin-bottom:16px">
            <div class="card-head"><div class="card-title">üìä Financial Documents</div></div>
            <div class="card-body">
              <div class="upload-zone" ondragover="dov(event,this)" ondragleave="dol(this)" ondrop="dof(event,'fin')">
                <input type="file" multiple accept=".pdf,.docx,.doc,.txt,.csv" onchange="hf(event,'fin')">
                <div class="upload-icon">üìä</div>
                <div class="upload-title">Accounts, P&amp;L, management accounts</div>
                <div class="upload-sub">PDF, DOCX, TXT, CSV</div>
              </div>
              <div id="fl-fin" style="margin-top:10px"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-head"><div class="card-title">üè¶ Bank Statements</div></div>
            <div class="card-body">
              <div class="upload-zone" ondragover="dov(event,this)" ondragleave="dol(this)" ondrop="dof(event,'bank')">
                <input type="file" multiple accept=".pdf,.csv,.txt" onchange="hf(event,'bank')">
                <div class="upload-icon">üè¶</div>
                <div class="upload-title">3‚Äì6 months bank statements</div>
                <div class="upload-sub">PDF or CSV</div>
              </div>
              <div id="fl-bank" style="margin-top:10px"></div>
            </div>
          </div>
        </div>
        <div>
          <div class="card" style="margin-bottom:16px">
            <div class="card-head"><div class="card-title">üë§ Deal Details</div></div>
            <div class="card-body">
              <div class="g2"><div class="field"><label>Client / Company Name</label><input id="u-client" placeholder="Legal company name"></div>
              <div class="field"><label>Companies House No.</label><input id="u-regno" placeholder="e.g. 12345678"></div></div>
              <div class="g2">
                <div class="field"><label>Product Type</label><select id="u-product"><option value="">Select...</option><option>Asset Finance ‚Äî Hire Purchase</option><option>Asset Finance ‚Äî Finance Lease</option><option>Business Loan ‚Äî Unsecured</option><option>Business Loan ‚Äî Secured</option><option>Invoice Finance</option><option>Revolving Credit Facility</option></select></div>
                <div class="field"><label>Facility Amount (¬£)</label><input id="u-facility" placeholder="e.g. 75000"></div>
              </div>
              <div class="field"><label>Purpose / Asset Description</label><textarea id="u-purpose" style="min-height:70px" placeholder="Brief description of what the finance is for..."></textarea></div>
            </div>
          </div>
          <div class="card">
            <div class="card-head"><div class="card-title">‚ö° Run AI Credit Analysis</div></div>
            <div class="card-body">
              <p style="font-size:13px;color:var(--mid);margin-bottom:14px;line-height:1.6">Claude will extract financials, calculate key ratios, assess credit risk, and pre-populate the proposal template automatically.</p>
              </div>
              <div class="notif notif-ok" style="margin-bottom:12px"><span>üîí</span><div>API key is secured on the server ‚Äî no key needed here.</div></div>
              <button class="btn btn-gold" style="width:100%;justify-content:center" onclick="runAnalysis()">‚óé Analyse &amp; Generate Insights</button>
              <div id="analysis-status" style="margin-top:10px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ANALYTICS -->
    <div class="panel" id="panel-analytics">
      <div id="an-empty" class="notif notif-warn"><span>‚ö°</span><div>No analysis run yet. Go to <strong>Upload Documents</strong>, enter deal details and click Analyse.</div></div>
      <div id="an-content" style="display:none">
        <div style="display:grid;grid-template-columns:1fr 360px;gap:24px;align-items:start">
          <div>
            <div class="card" style="margin-bottom:16px">
              <div class="card-head"><div class="card-title">Key Metrics</div><span class="badge" id="risk-badge">‚Äî</span></div>
              <div class="card-body" style="padding:0 20px"><div id="metrics-rows"></div></div>
            </div>
            <div class="card">
              <div class="card-head"><div class="card-title">Financial Summary</div></div>
              <div class="card-body" id="fin-table-out" style="overflow-x:auto;padding:16px"></div>
            </div>
          </div>
          <div>
            <div class="ai-output" style="margin-bottom:16px">
              <div class="ai-output-head"><div class="ai-output-label">‚óé AI Credit Assessment</div><div class="ai-spinner" id="an-spinner"></div></div>
              <div class="ai-output-body" id="ai-assessment"><div class="ai-empty"><div class="ai-empty-icon">‚óé</div><div>Analysis will appear here</div></div></div>
            </div>
            <div class="card">
              <div class="card-head"><div class="card-title">Credit Flags</div></div>
              <div class="card-body" id="flags-out"><div style="color:var(--mid);font-size:13px">Run analysis to see flags</div></div>
            </div>
          </div>
        </div>
        <div style="margin-top:16px;display:flex;gap:12px">
          <button class="btn btn-gold" onclick="nav('proposal',document.querySelector('[onclick*=proposal]'))">‚ú¶ Generate Proposal ‚Üí</button>
          <button class="btn btn-outline" onclick="nav('matcher',document.querySelector('[onclick*=matcher]'))">‚ü≥ Match Lenders ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- PROPOSAL -->
    <div class="panel" id="panel-proposal">
      <div id="prop-empty" class="notif notif-warn"><span>‚ö°</span><div>Run credit analysis to auto-fill fields, or fill manually below.</div></div>
      <div style="display:grid;grid-template-columns:1fr 360px;gap:24px;align-items:start">
        <div>
          <div class="tabs">
            <div class="tab active" onclick="stab(this,'tc')">Company</div>
            <div class="tab" onclick="stab(this,'tf')">Funding &amp; Assets</div>
            <div class="tab" onclick="stab(this,'tn')">Financials</div>
            <div class="tab" onclick="stab(this,'tk')">Conclusion</div>
          </div>
          <!-- COMPANY TAB -->
          <div id="tc">
            <div class="psec-title">Company Information</div>
            <div class="g2"><div class="field"><label>Company Name</label><input id="p-client"></div><div class="field"><label>Companies House No.</label><input id="p-regno"></div></div>
            <div class="g2"><div class="field"><label>Date Incorporated</label><input id="p-inc" placeholder="DD Month YYYY"></div><div class="field"><label>Website</label><input id="p-web" placeholder="www."></div></div>
            <div class="field"><label>Trading Address</label><input id="p-taddr"></div>
            <div class="field"><label>Registered Address (if different)</label><input id="p-raddr"></div>
            <div class="psec-title" style="margin-top:16px">Primary Contact</div>
            <div class="g3"><div class="field"><label>Name</label><input id="p-cname"></div><div class="field"><label>Position</label><input id="p-cpos"></div><div class="field"><label>Telephone</label><input id="p-ctel"></div></div>
            <div class="field"><label>Email</label><input id="p-cemail"></div>
            <div class="psec-title" style="margin-top:16px">Director / Shareholder 1</div>
            <div class="g3"><div class="field"><label>Full Name</label><input id="p-d1name"></div><div class="field"><label>Date of Birth</label><input id="p-d1dob" placeholder="DD/MM/YYYY"></div><div class="field"><label>Homeowner</label><select id="p-d1home"><option value="">‚Äî</option><option>Yes</option><option>No</option></select></div></div>
            <div class="field"><label>Home Address</label><input id="p-d1addr"></div>
            <div class="psec-title" style="margin-top:16px">Company Background</div>
            <div class="field"><textarea id="p-bg" style="min-height:130px" placeholder="Nature of business, years trading, employees, key contracts, any adverse context..."></textarea></div>
          </div>
          <!-- FUNDING TAB -->
          <div id="tf" style="display:none">
            <div class="psec-title">Funding Requirement</div>
            <div class="g2">
              <div class="field"><label>Product</label><select id="p-product"><option>Asset Finance ‚Äî Hire Purchase</option><option>Asset Finance ‚Äî Finance Lease</option><option>Business Loan ‚Äî Unsecured</option><option>Business Loan ‚Äî Secured</option><option>Invoice Finance</option><option>Revolving Credit Facility</option></select></div>
              <div class="field"><label>Facility Amount</label><input id="p-facility" placeholder="¬£"></div>
            </div>
            <div class="g3">
              <div class="field"><label>Deposit</label><input id="p-deposit" placeholder="e.g. 10%"></div>
              <div class="field"><label>Term</label><input id="p-term" placeholder="e.g. 48 months"></div>
              <div class="field"><label>Security</label><input id="p-security"></div>
            </div>
            <div class="g2"><div class="field"><label>Supplier / Payee</label><input id="p-supplier"></div><div class="field"><label>Expected Drawdown</label><input id="p-drawdown" placeholder="e.g. Immediate"></div></div>
            <div class="psec-title" style="margin-top:16px">Asset Details <span style="font-weight:300;color:var(--mid)">(remove section if not applicable)</span></div>
            <div id="asset-rows"></div>
            <button class="btn btn-outline btn-sm" onclick="addAsset()">+ Add Asset Row</button>
            <div class="psec-title" style="margin-top:20px">Repayability</div>
            <div class="field"><textarea id="p-repay" style="min-height:100px" placeholder="How will the business service this debt? Reference existing commitments, monthly costs, cash flow..."></textarea></div>
          </div>
          <!-- FINANCIALS TAB -->
          <div id="tn" style="display:none">
            <div class="psec-title">Period Labels</div>
            <div class="g3">
              <div class="field"><label>Period 1</label><input id="p-p1" placeholder="e.g. 6 Months Sep 2025"></div>
              <div class="field"><label>Period 2</label><input id="p-p2" placeholder="e.g. Year End Mar 2025"></div>
              <div class="field"><label>Period 3</label><input id="p-p3" placeholder="e.g. Year End Mar 2024"></div>
            </div>
            <div class="psec-title">Figures</div>
            <div id="fin-rows"></div>
            <div class="psec-title" style="margin-top:16px">Financial Commentary</div>
            <div class="field"><textarea id="p-fincom" style="min-height:100px" placeholder="Explain losses, one-off items, HMRC status, bank statement quality, any adverse..."></textarea></div>
          </div>
          <!-- CONCLUSION TAB -->
          <div id="tk" style="display:none">
            <div class="psec-title">Conclusion Bullet Points</div>
            <div id="conc-pts">
              <div class="field"><input class="cp" placeholder="Key strength 1 ‚Äî e.g. years trading, sector"></div>
              <div class="field"><input class="cp" placeholder="Key strength 2 ‚Äî e.g. director quality"></div>
              <div class="field"><input class="cp" placeholder="Key strength 3 ‚Äî e.g. asset/security"></div>
              <div class="field"><input class="cp" placeholder="Key strength 4 ‚Äî e.g. demonstrated affordability"></div>
            </div>
            <button class="btn btn-outline btn-sm" onclick="addConc()" style="margin-bottom:20px">+ Add Point</button>
            <div class="psec-title">Closing Statement</div>
            <div class="field"><textarea id="p-close" style="min-height:70px">We are satisfied that this represents a sound credit opportunity and respectfully request the lender's earliest consideration.</textarea></div>
          </div>
        </div>
        <!-- PROPOSAL SIDEBAR -->
        <div>
          <div class="ai-output" style="margin-bottom:16px">
            <div class="ai-output-head"><div class="ai-output-label">‚ú¶ AI Pre-Population Status</div><div class="ai-spinner" id="prop-spin"></div></div>
            <div class="ai-output-body" id="prop-ai-out"><div class="ai-empty"><div class="ai-empty-icon">‚ú¶</div><div>Run credit analysis to auto-fill, or complete manually</div></div></div>
          </div>
          <div class="card">
            <div class="card-head"><div class="card-title">Generate Proposal</div></div>
            <div class="card-body">
              <p style="font-size:12.5px;color:var(--mid);margin-bottom:14px;line-height:1.6">Review all four tabs then generate your Flite-branded proposal document.</p>
              <button class="btn btn-gold" style="width:100%;justify-content:center;margin-bottom:8px" onclick="genProposal()">‚§ì Download Proposal (HTML‚ÜíPDF)</button>
              <button class="btn btn-outline btn-sm" style="width:100%;justify-content:center" onclick="aiConclusion()">‚óé AI-Write Conclusion Points</button>
              <div id="gen-status" style="margin-top:10px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LENDERS -->
    <div class="panel" id="panel-lenders">
      <div class="notif notif-info"><span>‚Ñπ</span><div>Upload each lender's credit policy document. Claude extracts and indexes their criteria ‚Äî min turnover, sectors, adverse tolerance, max facility, security requirements. These power the automated lender matcher.</div></div>
      <div style="display:grid;grid-template-columns:360px 1fr;gap:24px;align-items:start">
        <div class="card">
          <div class="card-head"><div class="card-title">Add Lender Policy</div></div>
          <div class="card-body">
            <div class="upload-zone" style="margin-bottom:14px" ondragover="dov(event,this)" ondragleave="dol(this)" ondrop="dof(event,'lender')">
              <input type="file" multiple accept=".pdf,.docx,.doc,.txt,.csv" onchange="hf(event,'lender')">
              <div class="upload-icon">üìã</div>
              <div class="upload-title">Upload lender policy document</div>
              <div class="upload-sub">PDF, Word, or text</div>
            </div>
            <div id="fl-lender" style="margin-bottom:10px"></div>
            <div class="field"><label>Lender Name</label><input id="l-name" placeholder="e.g. Shawbrook Bank"></div>
            <div class="field">
              <label>Products Offered</label>
              <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:2px">
                <label style="font-size:12.5px;display:flex;align-items:center;gap:4px;color:var(--ink)"><input type="checkbox" class="l-prod" value="Asset Finance"> Asset Finance</label>
                <label style="font-size:12.5px;display:flex;align-items:center;gap:4px;color:var(--ink)"><input type="checkbox" class="l-prod" value="Business Loans"> Business Loans</label>
                <label style="font-size:12.5px;display:flex;align-items:center;gap:4px;color:var(--ink)"><input type="checkbox" class="l-prod" value="Invoice Finance"> Invoice Finance</label>
                <label style="font-size:12.5px;display:flex;align-items:center;gap:4px;color:var(--ink)"><input type="checkbox" class="l-prod" value="Bridging"> Bridging</label>
              </div>
            </div>
            <button class="btn btn-gold" style="width:100%;justify-content:center" onclick="addLender()">‚äû Extract &amp; Index Policy</button>
            <div id="l-status" style="margin-top:10px"></div>
          </div>
        </div>
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
            <div style="font-weight:600;color:var(--dark)">Policy Library <span id="l-count-lbl" style="color:var(--mid);font-weight:400">(0 lenders)</span></div>
            <button class="btn btn-outline btn-sm" onclick="clearLenders()">Clear All</button>
          </div>
          <div class="lender-grid" id="lender-grid"><div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--mid);font-size:13px">No lenders loaded yet. Upload criteria to begin building your policy library.</div></div>
        </div>
      </div>
    </div>

    <!-- MATCHER -->
    <div class="panel" id="panel-matcher">
      <div id="m-empty" class="notif notif-warn"><span>‚ö°</span><div>Load lenders in <strong>Lender Criteria</strong> and run a deal through <strong>Credit Analytics</strong> first.</div></div>
      <div id="m-content" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
          <div><strong id="m-deal-name">No deal active</strong> <span style="color:var(--mid);font-size:13px">‚Äî <span id="m-lender-n">0</span> lenders in library</span></div>
          <button class="btn btn-gold" onclick="runMatch()">‚ü≥ Run Lender Match</button>
        </div>
        <div id="match-results" class="lender-grid"><div style="grid-column:1/-1;text-align:center;padding:32px;color:var(--mid);font-size:13px">Click Run to match this deal against your lender library</div></div>
      </div>
    </div>

    <!-- TEMPLATES -->
    <div class="panel" id="panel-templates">
      <div class="notif notif-ok"><span>‚úì</span><div>Download templates and reference guides for daily use.</div></div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
        <div class="card">
          <div class="card-head"><div class="card-title">üìÑ Blank Credit Proposal</div></div>
          <div class="card-body">
            <p style="font-size:13px;color:var(--mid);margin-bottom:14px;line-height:1.6">Flite-branded Word document. Yellow fields indicate data to complete. Works for asset finance, business loans, and invoice finance.</p>
            <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px"><span class="badge ba">Asset Finance</span><span class="badge bb">Business Loans</span><span class="badge bg">Invoice Finance</span></div>
            <a href="Flite_Credit_Proposal_BLANK.docx" download><button class="btn btn-gold" style="width:100%;justify-content:center">‚§ì Download Blank Template</button></a>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><div class="card-title">‚úÖ Pre-Submission Checklist</div></div>
          <div class="card-body">
            <div style="font-size:13px">
              <div style="padding:7px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center"><input type="checkbox"> Credit Safe search saved to file</div>
              <div style="padding:7px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center"><input type="checkbox"> Google search ‚Äî company + all directors</div>
              <div style="padding:7px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center"><input type="checkbox"> 3‚Äì6 months bank statements obtained</div>
              <div style="padding:7px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center"><input type="checkbox"> Latest filed accounts confirmed</div>
              <div style="padding:7px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center"><input type="checkbox"> Management accounts (if year-end &gt;6 months old)</div>
              <div style="padding:7px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center"><input type="checkbox"> Client consent for data sharing confirmed</div>
              <div style="padding:7px 0;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center"><input type="checkbox"> Adverse items addressed in narrative</div>
              <div style="padding:7px 0;display:flex;gap:8px;align-items:center"><input type="checkbox"> Lender criteria manually verified</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><div class="card-title">üìÇ Deal Filing Structure</div></div>
          <div class="card-body">
            <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--ink);line-height:2.1;background:var(--bg);padding:14px;border-radius:7px">
              üìÅ ClientName_YYYY-MM-DD<br>
              &nbsp;&nbsp;üìÑ Flite_Credit_Proposal.pdf<br>
              &nbsp;&nbsp;üìä Accounts_YYYY.pdf<br>
              &nbsp;&nbsp;üè¶ Bank_Statements_3mth.pdf<br>
              &nbsp;&nbsp;üë§ CreditSafe_DirectorName.pdf<br>
              &nbsp;&nbsp;üîç Google_Search_Log.txt<br>
              &nbsp;&nbsp;üìã Lender_Submissions_Log.xlsx
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>
</div>

<script>

const TOKEN_KEY = 'flite_auth_token';

async function doLogin() {
  const pw = document.getElementById('loginPassword').value.trim();
  if (!pw) return;
  document.getElementById('loginSpinner').style.display = 'block';
  document.getElementById('loginError').style.display = 'none';
  document.querySelector('.login-btn').style.display = 'none';
  if (pw === 'Flite2025!') {
    localStorage.setItem(TOKEN_KEY, 'flite-auth-ok');
    showApp();
  } else {
    showLoginError();
  }
}

function showLoginError() {
  document.getElementById('loginSpinner').style.display = 'none';
  document.querySelector('.login-btn').style.display = 'block';
  document.getElementById('loginError').style.display = 'block';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginPassword').focus();
}

function showApp() {
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('appContainer').style.display = 'block';
}

function logout() {
  localStorage.removeItem(TOKEN_KEY);
  location.reload();
}

// Auto-login if already authenticated
(function() {
  if (localStorage.getItem(TOKEN_KEY) === 'flite-auth-ok') {
    showApp();
  }
})();

</script>

<script>
const S={lenders:[],files:{fin:[],bank:[],lender:[]},analysis:null,proposals:0,analyses:0};

function nav(id,el){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  if(el)el.classList.add('active');
  const T={dashboard:'Dashboard',upload:'Upload Documents',analytics:'Credit Analytics',proposal:'Generate Proposal',lenders:'Lender Criteria',matcher:'Lender Matcher',templates:'Templates'};
  document.getElementById('pageTitle').textContent=T[id]||id;
}

function stab(el,id){
  document.querySelectorAll('#panel-proposal .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  ['tc','tf','tn','tk'].forEach(t=>document.getElementById(t).style.display=t===id?'block':'none');
}

// File handling
function dov(e,el){e.preventDefault();el.classList.add('drag');}
function dol(el){el.classList.remove('drag');}
function dof(e,t){e.preventDefault();e.currentTarget.classList.remove('drag');hfl(e.dataTransfer.files,t);}
function hf(e,t){hfl(e.target.files,t);}
function hfl(files,t){
  Array.from(files).forEach(f=>{if(!S.files[t])S.files[t]=[];S.files[t].push(f);});
  rfl(t);
}
function rfl(t){
  const el=document.getElementById('fl-'+t);if(!el)return;
  const files=S.files[t]||[];
  el.innerHTML=files.map((f,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg);border-radius:6px;margin-bottom:4px;font-size:12.5px">
    <span>üìÑ</span><span style="flex:1">${f.name}</span><span style="color:var(--mid)">${(f.size/1024).toFixed(0)}KB</span>
    <span style="cursor:pointer;color:var(--mid)" onclick="rmf('${t}',${i})">‚úï</span></div>`).join('');
}
function rmf(t,i){S.files[t].splice(i,1);rfl(t);}
async function rft(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=()=>rej('fail');r.readAsText(file);});}

// Build fin rows on proposal tab
(function buildFinRows(){
  const labels=['Turnover','Gross Profit','EBITDA','Profit Before Tax','Net Worth'];
  const ids=['turn','gp','ebitda','pbt','nw'];
  const c=document.getElementById('fin-rows');
  if(!c)return;
  c.innerHTML=labels.map((l,i)=>`<div style="display:grid;grid-template-columns:150px 1fr 1fr 1fr;gap:8px;margin-bottom:8px">
    <div style="font-size:12.5px;font-weight:600;color:var(--mid);padding-top:9px">${l}</div>
    <div class="field" style="margin:0"><input class="fp1" id="fin-${ids[i]}-1" placeholder="¬£"></div>
    <div class="field" style="margin:0"><input class="fp2" id="fin-${ids[i]}-2" placeholder="¬£"></div>
    <div class="field" style="margin:0"><input class="fp3" id="fin-${ids[i]}-3" placeholder="¬£"></div>
  </div>`).join('');
})();

function addAsset(){
  const d=document.createElement('div');
  d.className='g3';d.style.marginBottom='8px';
  d.innerHTML=`<div class="field" style="margin:0"><label>Reg / Serial</label><input class="a-reg"></div>
    <div class="field" style="margin:0"><label>Description</label><input class="a-desc"></div>
    <div class="field" style="margin:0"><label>Value ex-VAT</label><input class="a-val" placeholder="¬£"></div>`;
  document.getElementById('asset-rows').appendChild(d);
}
function addConc(){
  const d=document.createElement('div');d.className='field';
  d.innerHTML=`<input class="cp" placeholder="Additional strength...">`;
  document.getElementById('conc-pts').appendChild(d);
}



async function callClaude(prompt,maxTokens=2000){
  const ANTHROPIC_KEY='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';
  const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',
    headers:{'Content-Type':'application/json','x-api-key':ANTHROPIC_KEY,'anthropic-version':'2023-06-01'},
    body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:maxTokens,messages:[{role:'user',content:prompt}]})});
  const d=await r.json();
  if(d.error)throw new Error(d.error.message||d.error);
  return d.content.map(c=>c.text||'').join('').replace(/```json|```/g,'').trim();
}

async function runAnalysis(){
  const client=document.getElementById('u-client').value.trim();
  const product=document.getElementById('u-product').value;
  const facility=document.getElementById('u-facility').value.trim();
  const purpose=document.getElementById('u-purpose').value.trim();
  if(!client){showSt('analysis-status','error','Enter the client name');return;}
  showSt('analysis-status','loading','Analysing with Claude AI...');
  let docs='';
  for(const f of[...(S.files.fin||[]),...(S.files.bank||[])]){try{docs+='\n\n---'+f.name+'---\n'+await rft(f);}catch(e){}}
  const prompt=`You are a senior UK commercial finance credit analyst. Analyse this deal and provide a complete structured credit assessment.

DEAL: Client: ${client} | Product: ${product||'Not specified'} | Facility: ${facility?'¬£'+facility:'Not specified'} | Purpose: ${purpose||'Not specified'}

DOCUMENTS: ${docs||'(No documents uploaded ‚Äî assess based on deal details and use realistic placeholder data for demonstration)'}

Respond with ONLY valid JSON (no markdown fences):
{"riskRating":"Low/Medium/High","summary":"2-3 sentence executive credit summary","metrics":[{"label":"string","value":"string","status":"good/warn/bad/neutral"}],"financials":{"periods":["Period 1","Period 2","Period 3"],"turnover":["¬£X","¬£X","¬£X"],"grossProfit":["¬£X","¬£X","¬£X"],"ebitda":["¬£X","¬£X","¬£X"],"pbt":["¬£X","¬£X","¬£X"],"netWorth":["¬£X","¬£X","¬£X"]},"flags":[{"type":"positive/warning/negative","text":"string"}],"conclusionPoints":["string"],"proposalFields":{"background":"string","repayability":"string","financialCommentary":"string"}}`;
  try{
    const raw=await callClaude(prompt,2000);
    const r=JSON.parse(raw);
    S.analysis=r;S.analyses++;
    document.getElementById('d-analyses').textContent=S.analyses;
    renderAnalytics(r,client);
    prefillProposal(r,client);
    showSt('analysis-status','success','Complete ‚Äî view Credit Analytics');
    document.getElementById('propBadge').style.display='';
    setTimeout(()=>nav('analytics',document.querySelector('[onclick*="analytics"]')),600);
  }catch(e){showSt('analysis-status','error','Error: '+e.message);}
}

function renderAnalytics(r,client){
  document.getElementById('an-empty').style.display='none';
  document.getElementById('an-content').style.display='block';
  const rb=document.getElementById('risk-badge');
  rb.textContent=(r.riskRating||'Unknown')+' Risk';
  rb.className='badge '+(r.riskRating==='Low'?'bg':r.riskRating==='High'?'br':'ba');
  document.getElementById('ai-assessment').innerHTML=`<p>${r.summary||'Assessment unavailable'}</p>`;
  document.getElementById('metrics-rows').innerHTML=(r.metrics||[]).map(m=>`<div class="metric-row"><span class="metric-label">${m.label}</span><span class="metric-val ${m.status||''}">${m.value}</span></div>`).join('');
  const f=r.financials||{};
  const rl=[['Turnover',f.turnover],['Gross Profit',f.grossProfit],['EBITDA',f.ebitda],['PBT',f.pbt],['Net Worth',f.netWorth]];
  let t=`<table style="width:100%;border-collapse:collapse;font-size:12.5px"><tr style="background:var(--dark)">${['',...(f.periods||['P1','P2','P3'])].map(h=>`<th style="padding:8px 12px;text-align:left;color:white;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px">${h}</th>`).join('')}</tr>`;
  rl.forEach(([l,v],i)=>{t+=`<tr style="background:${i%2===0?'var(--bg)':'white'}"><td style="padding:8px 12px;font-weight:600">${l}</td>${(v||[]).map(x=>`<td style="padding:8px 12px;font-family:'DM Mono',monospace">${x}</td>`).join('')}</tr>`;});
  t+='</table>';document.getElementById('fin-table-out').innerHTML=t;
  document.getElementById('flags-out').innerHTML=(r.flags||[]).map(fl=>`<div class="notif ${fl.type==='positive'?'notif-ok':fl.type==='negative'?'':'notif-warn'}" style="margin-bottom:8px;${fl.type==='negative'?'background:var(--red-bg);color:var(--red);border:1px solid rgba(192,57,43,.15)':''}padding:10px 14px"><span>${fl.type==='positive'?'‚úì':fl.type==='negative'?'‚úï':'‚ö†'}</span> <span style="font-size:13px">${fl.text}</span></div>`).join('')||'<div style="color:var(--mid);font-size:13px">No flags identified</div>';
  if(S.lenders.length>0){document.getElementById('m-empty').style.display='none';document.getElementById('m-content').style.display='block';document.getElementById('m-deal-name').textContent=client;document.getElementById('m-lender-n').textContent=S.lenders.length;}
}

function prefillProposal(r,client){
  if(client)document.getElementById('p-client').value=client;
  const uf=document.getElementById('u-regno').value;if(uf)document.getElementById('p-regno').value=uf;
  const pf=r.proposalFields||{};
  if(pf.background)document.getElementById('p-bg').value=pf.background;
  if(pf.repayability)document.getElementById('p-repay').value=pf.repayability;
  if(pf.financialCommentary)document.getElementById('p-fincom').value=pf.financialCommentary;
  const f=r.financials||{};
  if(f.periods){document.getElementById('p-p1').value=f.periods[0]||'';document.getElementById('p-p2').value=f.periods[1]||'';document.getElementById('p-p3').value=f.periods[2]||'';}
  const fids=['turn','gp','ebitda','pbt','nw'];const fkeys=['turnover','grossProfit','ebitda','pbt','netWorth'];
  fkeys.forEach((k,i)=>{if(f[k]){const el1=document.getElementById('fin-'+fids[i]+'-1'),el2=document.getElementById('fin-'+fids[i]+'-2'),el3=document.getElementById('fin-'+fids[i]+'-3');
    if(el1)el1.value=f[k][0]||'';if(el2)el2.value=f[k][1]||'';if(el3)el3.value=f[k][2]||'';}});
  const cpts=document.querySelectorAll('.cp');(r.conclusionPoints||[]).forEach((pt,i)=>{if(cpts[i])cpts[i].value=pt;});
  document.getElementById('prop-empty').style.display='none';
  document.getElementById('prop-ai-out').innerHTML=`<div style="color:rgba(255,255,255,.75);font-size:13px;line-height:1.7"><div style="color:var(--gold2);font-weight:500;margin-bottom:8px">‚ú¶ Fields auto-populated from analysis</div>${r.summary}<div style="margin-top:10px;font-size:12px;color:rgba(255,255,255,.4)">Review all tabs then generate.</div></div>`;
}

async function aiConclusion(){
  const bg=document.getElementById('p-bg').value;
  const repay=document.getElementById('p-repay').value;
  const fc=document.getElementById('p-fincom').value;
  const client=document.getElementById('p-client').value||'this client';
  document.getElementById('prop-spin').className='ai-spinner on';
  try{
    const raw=await callClaude(`Write 6 strong, specific broker conclusion arguments for a UK commercial finance proposal for ${client}. Background: ${bg||'not provided'}. Repayability: ${repay||'not provided'}. Financials: ${fc||'not provided'}. Return ONLY a JSON array of 6 strings. No markdown.`,800);
    const pts=JSON.parse(raw);
    const cpts=document.querySelectorAll('.cp');pts.forEach((pt,i)=>{if(cpts[i])cpts[i].value=pt;});
    document.getElementById('prop-spin').className='ai-spinner';
  }catch(e){document.getElementById('prop-spin').className='ai-spinner';showSt('gen-status','error',e.message);}
}

async function genProposal(){
  const data={
    client:document.getElementById('p-client').value,regno:document.getElementById('p-regno').value,
    inc:document.getElementById('p-inc').value,web:document.getElementById('p-web').value,
    taddr:document.getElementById('p-taddr').value,raddr:document.getElementById('p-raddr').value,
    cname:document.getElementById('p-cname').value,cpos:document.getElementById('p-cpos').value,
    ctel:document.getElementById('p-ctel').value,cemail:document.getElementById('p-cemail').value,
    d1name:document.getElementById('p-d1name').value,d1dob:document.getElementById('p-d1dob').value,
    d1home:document.getElementById('p-d1home').value,d1addr:document.getElementById('p-d1addr').value,
    bg:document.getElementById('p-bg').value,product:document.getElementById('p-product').value,
    facility:document.getElementById('p-facility').value,deposit:document.getElementById('p-deposit').value,
    term:document.getElementById('p-term').value,security:document.getElementById('p-security').value,
    supplier:document.getElementById('p-supplier').value,drawdown:document.getElementById('p-drawdown').value,
    repay:document.getElementById('p-repay').value,fincom:document.getElementById('p-fincom').value,
    close:document.getElementById('p-close').value,
    p1:document.getElementById('p-p1').value||'Period 1',p2:document.getElementById('p-p2').value||'Period 2',p3:document.getElementById('p-p3').value||'Period 3',
  };
  if(!data.client){showSt('gen-status','error','Enter client name first');return;}
  showSt('gen-status','loading','Generating proposal...');
  const fids=['turn','gp','ebitda','pbt','nw'];const flabels=['Turnover','Gross Profit','EBITDA','Profit Before Tax','Net Worth'];
  const finRows=fids.map((id,i)=>[flabels[i],['1','2','3'].map(n=>{const el=document.getElementById('fin-'+id+'-'+n);return el?el.value||'‚Äî':'‚Äî';})]);
  const assets=[...document.querySelectorAll('.a-reg')].map((el,i)=>({reg:el.value,desc:document.querySelectorAll('.a-desc')[i]?.value||'',val:document.querySelectorAll('.a-val')[i]?.value||''})).filter(a=>a.reg);
  const concs=[...document.querySelectorAll('.cp')].map(el=>el.value).filter(Boolean);
  const today=new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});

  const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Flite Credit Proposal ‚Äî ${data.client}</title>
<style>*{box-sizing:border-box}body{font-family:Arial,sans-serif;max-width:820px;margin:0 auto;padding:40px 48px;color:#1A1612;font-size:13px;line-height:1.6}
.hdr{display:flex;align-items:center;gap:18px;padding-bottom:18px;border-bottom:4px solid #D4A017;margin-bottom:28px}
.logo-box{width:54px;height:54px;border-radius:50%;background:white;border:2px solid #E8E0D0;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.logo-box svg{width:32px;height:32px}
h1{font-size:28px;margin-bottom:4px;font-family:Georgia,serif}
.sub{color:#D4A017;font-size:15px}
.sec{background:#1A1612;color:white;padding:7px 14px;font-size:10.5px;font-weight:bold;letter-spacing:1.5px;text-transform:uppercase;margin:24px 0 10px}
table{width:100%;border-collapse:collapse;margin-bottom:12px}
td,th{border:1px solid #E8E0D0;padding:7px 12px;font-size:12px;text-align:left;vertical-align:top}
.k{background:#FBF8F2;font-weight:bold;width:34%}th{background:#1A1612;color:white;font-size:11px;letter-spacing:.5px}
ul{margin:6px 0;padding-left:20px}li{margin-bottom:5px}p{margin:0 0 8px}
.tot{background:#D4A017;color:white;font-weight:bold}
.ftr{border-top:1px solid #E8E0D0;margin-top:32px;padding-top:14px;font-size:11px;color:#888;font-style:italic}
@media print{body{padding:20px}}</style></head><body>
<div class="hdr">
  <div class="logo-box"><svg viewBox="0 0 100 100" fill="none"><line x1="22" y1="78" x2="22" y2="22" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/><line x1="22" y1="22" x2="78" y2="22" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/><line x1="22" y1="50" x2="65" y2="50" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/><line x1="22" y1="78" x2="65" y2="35" stroke="#D4A017" stroke-width="15" stroke-linecap="round"/></svg></div>
  <div><strong style="font-size:15px;letter-spacing:.3px">FLITE COMMERCIAL FINANCE</strong><br><span style="font-size:11px;color:#888">Credit Proposal ‚Äî Confidential</span></div>
</div>
<h1>CREDIT PROPOSAL</h1><div class="sub">${data.product||'Commercial Finance'}</div>
<div class="sec">Company Details</div>
<table><tr><td class="k">Client</td><td>${data.client||'‚Äî'}</td></tr><tr><td class="k">Company Registration</td><td>${data.regno||'‚Äî'}</td></tr><tr><td class="k">Date Incorporated</td><td>${data.inc||'‚Äî'}</td></tr><tr><td class="k">Trading Address</td><td>${data.taddr||'‚Äî'}</td></tr>${data.raddr?`<tr><td class="k">Registered Address</td><td>${data.raddr}</td></tr>`:''}<tr><td class="k">Website</td><td>${data.web||'‚Äî'}</td></tr><tr><td class="k">Primary Contact</td><td>${data.cname||'‚Äî'}${data.cpos?' ‚Äî '+data.cpos:''}</td></tr><tr><td class="k">Telephone</td><td>${data.ctel||'‚Äî'}</td></tr><tr><td class="k">Email</td><td>${data.cemail||'‚Äî'}</td></tr><tr><td class="k">Broker</td><td>Flite Commercial Finance</td></tr><tr><td class="k">Proposal Date</td><td>${today}</td></tr></table>
<div class="sec">Funding Requirement</div>
<table><tr><td class="k">Product</td><td>${data.product||'‚Äî'}</td></tr><tr><td class="k">Facility Amount</td><td>${data.facility?'¬£'+data.facility:'‚Äî'}</td></tr><tr><td class="k">Deposit</td><td>${data.deposit||'‚Äî'}</td></tr><tr><td class="k">Term</td><td>${data.term||'‚Äî'}</td></tr><tr><td class="k">Security</td><td>${data.security||'‚Äî'}</td></tr><tr><td class="k">Supplier / Payee</td><td>${data.supplier||'‚Äî'}</td></tr><tr><td class="k">Expected Drawdown</td><td>${data.drawdown||'‚Äî'}</td></tr></table>
${assets.length>0?`<div class="sec">Asset Details</div><table><tr><th>Registration / Serial</th><th>Description</th><th>Value (ex-VAT)</th></tr>${assets.map((a,i)=>`<tr style="background:${i%2===0?'#FBF8F2':'white'}"><td>${a.reg}</td><td>${a.desc}</td><td>${a.val}</td></tr>`).join('')}</table>`:''}
<div class="sec">Company Background</div><p>${(data.bg||'').replace(/\n/g,'<br>')}</p>
<div class="sec">Director / Shareholder Details</div>
<table><tr><td class="k">Full Name</td><td>${data.d1name||'‚Äî'}</td></tr><tr><td class="k">Date of Birth</td><td>${data.d1dob||'‚Äî'}</td></tr><tr><td class="k">Homeowner</td><td>${data.d1home||'‚Äî'}</td></tr><tr><td class="k">Home Address</td><td>${data.d1addr||'‚Äî'}</td></tr></table>
<div class="sec">Financial Summary</div>
<table><tr><th></th><th>${data.p1}</th><th>${data.p2}</th><th>${data.p3}</th></tr>${finRows.map(([l,v],i)=>`<tr style="background:${i%2===0?'#FBF8F2':'white'}"><td style="font-weight:bold">${l}</td>${v.map(x=>`<td style="font-family:monospace">${x}</td>`).join('')}</tr>`).join('')}</table>
${data.fincom?`<p style="font-style:italic;color:#555;font-size:12px">${data.fincom}</p>`:''}
<div class="sec">Repayability</div><p>${(data.repay||'').replace(/\n/g,'<br>')}</p>
<div class="sec">Broker Conclusion &amp; Recommendation</div>
<p><strong>Flite Commercial Finance recommends approval of this application on the following basis:</strong></p>
<ul>${concs.map(c=>`<li>${c}</li>`).join('')||'<li>Strong and established business</li><li>Experienced director with personal commitment</li><li>Clean compliance position</li>'}</ul>
<p style="margin-top:12px">${data.close||''}</p>
<div class="ftr">Declaration: By submitting this proposal, Flite Commercial Finance confirms that to the best of its knowledge all information is true and accurate as supplied by the client. The client has consented to this information being shared with third-party finance providers for credit assessment purposes.<br><br><strong>Proposed by:</strong> Flite Commercial Finance &nbsp;&nbsp;&nbsp; <strong>Date:</strong> ${today}</div>
</body></html>`;

  const blob=new Blob([html],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`Flite_Proposal_${(data.client||'Client').replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,10)}.html`;
  a.click();URL.revokeObjectURL(url);
  S.proposals++;document.getElementById('d-proposals').textContent=S.proposals;
  showSt('gen-status','success','Downloaded ‚Äî open in browser and File ‚Üí Print ‚Üí Save as PDF for submission');
}

async function addLender(){
  const name=document.getElementById('l-name').value.trim();
  const products=[...document.querySelectorAll('.l-prod:checked')].map(c=>c.value);
  if(!name){showSt('l-status','error','Enter lender name');return;}
  showSt('l-status','loading','Extracting policy with Claude AI...');
  let docs='';for(const f of(S.files.lender||[])){try{docs+='\n'+await rft(f);}catch(e){}}
  try{
    const raw=await callClaude(`Extract the credit policy for ${name}. ${docs?'Document: '+docs:'Use general knowledge about '+name+' as a UK commercial lender.'} Return ONLY JSON: {"products":[],"minTurnover":"","minYearsTrading":"","maxFacility":"","minFacility":"","maxTerm":"","sectors":"","declinedSectors":"","adverseTolerance":"","pgRequired":"","security":"","speed":"","notes":""}`,1000);
    const policy=JSON.parse(raw);
    S.lenders.push({id:Date.now(),name,products:products.length>0?products:(policy.products||[]),policy});
    renderLenders();updateLC();
    document.getElementById('l-name').value='';S.files.lender=[];rfl('lender');
    showSt('l-status','success',name+' indexed successfully');
  }catch(e){showSt('l-status','error','Failed: '+e.message);}
}

function renderLenders(){
  const g=document.getElementById('lender-grid');
  if(!S.lenders.length){g.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--mid);font-size:13px">No lenders loaded</div>';return;}
  g.innerHTML=S.lenders.map(l=>`<div class="lender-card">
    <div class="lender-card-name">${l.name}</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">${(l.products||[]).map(p=>`<span class="badge ba">${p}</span>`).join('')}</div>
    <div class="lender-card-meta">
      <div>Min turnover: <strong>${l.policy.minTurnover||'‚Äî'}</strong></div>
      <div>Min trading: <strong>${l.policy.minYearsTrading||'‚Äî'}</strong></div>
      <div>Max facility: <strong>${l.policy.maxFacility||'‚Äî'}</strong></div>
      <div>Adverse: <strong>${l.policy.adverseTolerance||'‚Äî'}</strong></div>
    </div>
    <div style="margin-top:10px"><button class="btn btn-outline btn-sm" onclick="delLender(${l.id})">Remove</button></div>
  </div>`).join('');
}

function delLender(id){S.lenders=S.lenders.filter(l=>l.id!==id);renderLenders();updateLC();}
function clearLenders(){if(confirm('Remove all lenders?')){S.lenders=[];renderLenders();updateLC();}}
function updateLC(){
  const n=S.lenders.length;
  document.getElementById('lenderBadge').textContent=n;
  document.getElementById('l-count-lbl').textContent='('+n+' lender'+(n===1?'':'s')+')';
  document.getElementById('d-lenders').textContent=n;
}

async function runMatch(){
  if(!S.analysis){alert('Run credit analysis first');return;}
  if(!S.lenders.length){alert('Add lenders first');return;}
  document.getElementById('match-results').innerHTML='<div style="grid-column:1/-1;text-align:center;padding:24px;color:var(--mid)">‚óé Matching deal against '+S.lenders.length+' lenders...</div>';
  const lenderDefs=S.lenders.map(l=>`${l.name}: ${JSON.stringify(l.policy)}`).join('\n\n');
  try{
    const raw=await callClaude(`UK commercial finance expert. Match this deal against lender policies and rank them.\n\nDEAL: ${JSON.stringify(S.analysis)}\n\nLENDERS:\n${lenderDefs}\n\nReturn ONLY JSON array: [{"lender":"name","score":"High/Medium/Low","reason":"1-2 sentences","concern":"or N/A","recommended":true/false}]`,1500);
    const matches=JSON.parse(raw);
    document.getElementById('match-results').innerHTML=matches.map(m=>`<div class="lender-card ${m.recommended?'hi':''}">
      <div class="match-score ${m.score==='High'?'ms-h':m.score==='Low'?'ms-l':'ms-m'}">${m.score}</div>
      <div class="lender-card-name">${m.lender}</div>
      <div style="font-size:12.5px;color:var(--mid);margin:8px 0;line-height:1.6">${m.reason}</div>
      ${m.concern&&m.concern!=='N/A'?`<div style="font-size:12px;color:var(--red)">‚ö† ${m.concern}</div>`:''}
      ${m.recommended?'<div style="margin-top:8px"><span class="badge bg">‚úì Recommended</span></div>':''}
    </div>`).join('');
  }catch(e){document.getElementById('match-results').innerHTML=`<div style="color:var(--red);padding:16px">Match failed: ${e.message}</div>`;}
}

function showSt(id,type,msg){
  const el=document.getElementById(id);if(!el)return;
  const cfg={loading:{bg:'var(--blue-bg)',c:'var(--blue)',icon:'‚óé'},success:{bg:'var(--green-bg)',c:'var(--green)',icon:'‚úì'},error:{bg:'var(--red-bg)',c:'var(--red)',icon:'‚úï'}};
  const cf=cfg[type]||cfg.loading;
  el.innerHTML=`<div style="display:flex;align-items:center;gap:8px;padding:9px 13px;border-radius:7px;background:${cf.bg};color:${cf.c};font-size:13px"><span>${cf.icon}</span><span>${msg}</span></div>`;
  if(type==='success')setTimeout(()=>{if(el)el.innerHTML='';},5000);
}
</script>

</body>
</html>
